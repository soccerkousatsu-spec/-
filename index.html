<!DOCTYPE html>
<html lang="ja">
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ã‚¬ãƒã§å‹ã¡ã«è¡Œã</title>
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³å®šç¾© (ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ) --- */
        :root {
            --bg-color: #F9F8F4;       /* ç”Ÿæˆã‚Šï¼ˆã‚¯ãƒªãƒ¼ãƒ è‰²ï¼‰ */
            --text-main: #464646;      /* ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
            --text-sub: #888888;       /* è–„ã„ã‚°ãƒ¬ãƒ¼ */
            --card-bg: #FFFFFF;        /* ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ï¼ˆç™½ï¼‰ */
            --border-color: #E6E4DD;   /* è–„ã„å¢ƒç•Œç·š */
            
            /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ */
            --color-green: #7A9D54;    /* æŠ¹èŒ¶ */
            --color-red: #C75B5B;      /* ãƒ†ãƒ©ã‚³ãƒƒã‚¿ */
            --color-blue: #6A8caf;     /* ãƒ–ãƒ«ãƒ¼ */
            --color-dark: #2D2D2D;     /* é»’ */
            
            --radius: 16px;
            --shadow: 0 4px 12px rgba(0,0,0,0.03);
        }

        /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-color); color: var(--text-main);
            
            /* Safariå¯¾å¿œã®é«˜ã•æŒ‡å®š */
            height: 100vh;
            height: 100dvh;
            
            display: flex; flex-direction: column;
            overflow: hidden; -webkit-font-smoothing: antialiased;
            
            /* iPhoneã®ãƒãƒƒãƒå¯¾å¿œ */
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .screen {
            display: none; flex: 1; flex-direction: column;
            padding: 24px; overflow-y: auto; position: relative;
        }
        .screen.active { display: flex; }

        h1, h2 { text-align: center; margin: 10px 0 20px 0; font-size: 1.2rem; font-weight: 700; letter-spacing: 0.05em; }

        /* --- èµ·å‹•ç”»é¢ï¼ˆã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ï¼‰ --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #FFFFFF;
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        #splash-screen.fade-out { opacity: 0; pointer-events: none; }
        .splash-logo {
            width: 180px; height: auto;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* --- æ—¥ä»˜ãƒŠãƒ“ --- */
        .date-nav-container { display: flex; justify-content: center; align-items: center; margin-bottom: 24px; gap: 20px; }
        .date-nav-btn {
            background: transparent; border: 1px solid var(--border-color); color: var(--text-main);
            width: 40px; height: 40px; border-radius: 50%; font-size: 1.2em; cursor: pointer;
            padding: 0; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; box-shadow: var(--shadow);
        }
        .date-nav-btn:active { transform: scale(0.95); background: #eee; }
        .date-display-wrapper { position: relative; text-align: center; }
        .date-text { font-size: 1.8em; font-weight: 800; letter-spacing: 0.05em; color: var(--color-dark); cursor: pointer; }
        .date-sub { font-size: 0.75em; color: var(--text-sub); margin-top: 4px; }
        #date-picker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* --- ãƒœã‚¿ãƒ³ --- */
        button {
            border: none; padding: 16px; font-size: 16px; border-radius: var(--radius);
            margin: 6px 0; cursor: pointer; font-weight: 700; width: 100%;
            touch-action: manipulation; transition: transform 0.1s, opacity 0.2s;
            box-shadow: var(--shadow); color: #fff;
        }
        button:active { opacity: 0.9; transform: scale(0.98); }
        .big-btn { background: var(--color-dark); font-size: 1.4em; padding: 24px; letter-spacing: 0.1em; }
        .btn-outline { background: var(--card-bg); color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-green { background-color: var(--color-green); }
        .btn-red { background-color: var(--color-red); }
        .btn-blue { background-color: var(--color-blue); }
        .btn-small-nav {
            font-size: 0.8em; padding: 8px 16px; width: auto; background: transparent;
            color: var(--text-sub); border: 1px solid var(--border-color); border-radius: 20px; box-shadow: none;
        }

        /* --- ãƒ‰ãƒƒãƒˆè¡¨ç¤º --- */
        .label-text { text-align: center; font-size: 0.8em; color: var(--text-sub); margin-bottom: 8px; letter-spacing: 0.1em; }
        .dot-container {
            display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-bottom: 30px;
            background: var(--card-bg); padding: 20px; border-radius: var(--radius);
            min-height: 60px; align-items: center; box-shadow: var(--shadow); border: 1px solid var(--border-color);
        }
        .dot { width: 18px; height: 18px; border-radius: 50%; background-color: #eee; }
        .dot.green { background-color: var(--color-green); }
        .dot.red { background-color: var(--color-red); }

        /* --- ãƒªã‚¹ãƒˆãƒ»è¨­å®š --- */
        .list-container { display: flex; flex-direction: column; gap: 12px; }
        .list-item {
            background: var(--card-bg); padding: 18px; border-radius: var(--radius); cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow); border: 1px solid transparent; transition: border 0.2s;
        }
        .list-item:active { border-color: var(--text-sub); }
        .item-text { flex: 1; font-weight: 700; text-align: left; color: var(--text-main); line-height: 1.4; }
        .delete-btn {
            background: #fff0f0; color: var(--color-red); width: 32px; height: 32px;
            border-radius: 50%; font-size: 14px; display: flex; align-items: center; justify-content: center;
            margin-left: 10px; padding: 0; cursor: pointer; box-shadow: none;
        }
        .add-btn-dashed { background: transparent; color: var(--text-sub); border: 2px dashed var(--border-color); box-shadow: none; justify-content: center; }

        /* --- ãƒ—ãƒ¬ã‚¤ä¸­ãƒãƒ– --- */
        .hub-container { display: flex; flex-direction: column; gap: 20px; justify-content: center; flex: 1; }
        .hub-title {
            text-align: center; font-size: 2.4em; margin-bottom: 30px; font-weight: 900;
            color: var(--color-dark); letter-spacing: 0.05em;
        }

        /* --- åˆ†æç”»é¢ --- */
        .filter-card {
            background: var(--card-bg); padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 24px; border: 1px solid var(--border-color);
        }
        .filter-row { display: flex; gap: 12px; margin-bottom: 12px; }
        .filter-row:last-child { margin-bottom: 0; }
        select, input[type="date"], input[type="text"], textarea {
            width: 100%; padding: 12px; font-size: 16px; border-radius: 8px;
            border: 1px solid var(--border-color); background: #fcfcfc;
            color: var(--text-main); outline: none; box-sizing: border-box; -webkit-appearance: none;
            font-family: inherit;
        }
        textarea { resize: vertical; min-height: 80px; }

        .stats-card {
            background: var(--card-bg); padding: 20px; margin-bottom: 20px;
            border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border-color);
        }
        .stats-header { font-size: 0.85em; color: var(--text-sub); margin-bottom: 8px; font-weight: 700; }
        .win-rate-bar-bg { width: 100%; height: 24px; background: #eee; border-radius: 12px; overflow: hidden; margin-top: 10px; }
        .win-rate-bar-fill { height: 100%; background: var(--color-green); width: 0%; transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        .reason-rank-item { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 12px 0; font-size: 0.95em; }
        .reason-rank-item:last-child { border-bottom: none; }

        /* --- ç”»é¢è¡¨ç¤ºæ©Ÿèƒ½ --- */
        #display-screen { padding: 0; background: #111; transition: background 0.3s; }
        #display-text-area {
            flex: 1; display: flex; align-items: center; justify-content: center;
            text-align: center; font-weight: 900; color: #fff;
            white-space: pre-wrap; cursor: pointer; line-height: 1.2;
            padding: 20px; user-select: none; letter-spacing: 0.05em;
        }
        .controls-overlay {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.98); 
            
            padding-top: 10px; /* ãƒãƒ³ãƒ‰ãƒ«ç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹ */
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            padding-left: calc(24px + env(safe-area-inset-left));
            padding-right: calc(24px + env(safe-area-inset-right));
            
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            transform: translateY(100%); 
            transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1);
            
            display: flex; flex-direction: column; gap: 16px; z-index: 100;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            
            max-height: 80dvh; 
            overflow-y: auto;
        }
        .controls-overlay.show { transform: translateY(0); }
        
        /* ã‚¹ãƒ¯ã‚¤ãƒ—ç”¨ã®ãƒãƒ³ãƒ‰ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .drag-handle {
            width: 40px; height: 5px; background: #ddd; border-radius: 3px;
            margin: 0 auto 10px auto; flex-shrink: 0;
        }
        
        .preset-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .preset-item { 
            flex: 0 0 auto; padding: 12px 20px; background: #f0f0f0; 
            border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 0.9em;
            color: #333; display: flex; align-items: center; gap: 8px; border: 1px solid #ddd;
        }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); }

        /* ç†ç”±é¸æŠãƒœã‚¿ãƒ³ */
        .reason-btn {
            display: inline-block; margin: 4px; padding: 10px 16px;
            border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main);
            border-radius: 24px; cursor: pointer; transition: all 0.2s; font-weight: bold;
        }
        .reason-btn.selected { background: var(--text-main); color: #fff; border-color: var(--text-main); }

        /* è¨­å®šç”»é¢ */
        .setting-input-group {
            margin-bottom: 20px; background: var(--card-bg); padding: 20px;
            border-radius: var(--radius); border: 1px solid var(--border-color); box-shadow: var(--shadow);
        }
        .setting-label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.9em; }

        /* ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ãƒ»ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”¨ */
        .color-picker-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
        input[type="color"] {
            -webkit-appearance: none; border: none; width: 40px; height: 40px; 
            cursor: pointer; background: none; padding: 0;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid #ddd; border-radius: 8px; }
        
        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 6px; background: #ddd;
            border-radius: 3px; outline: none; margin-top: 10px; border: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px; background: var(--color-dark);
            border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæ–‡å­—ã ã‘ãƒ•ãƒ¯ãƒƒã¨å‡ºã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ */
        #nice-popup {
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            background: transparent; border: none; box-shadow: none;
            color: var(--color-green); font-size: 4rem; font-weight: 900; font-style: italic; white-space: nowrap;
            text-shadow: 3px 3px 0 #fff, -3px -3px 0 #fff, 3px -3px 0 #fff, -3px 3px 0 #fff, 0 5px 15px rgba(0,0,0,0.1);
            pointer-events: none; z-index: 9999; opacity: 0;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾©ï¼ˆãã®å ´ã§ãµã‚ã£ã¨ï¼‰ */
        @keyframes popUpSoft {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.0); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
        }
        #nice-popup.pop { animation: popUpSoft 1.0s ease-out forwards; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="logo.png" alt="LOGO" class="splash-logo">
    </div>

    <div id="home-screen" class="screen active">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <button class="btn-small-nav" onclick="showScreen('settings-screen')">âš™ï¸ è¨­å®š</button>
            <div style="font-weight:900; letter-spacing:0.1em; color:var(--text-main);">MENTAL CHECKER</div>
            <div style="width:60px;"></div>
        </div>

        <div class="date-nav-container">
            <button class="date-nav-btn" onclick="changeDate(-1)">â®</button>
            <div class="date-display-wrapper">
                <div class="date-text" id="current-date-text">--/--</div>
                <div class="date-sub">ã‚¿ãƒƒãƒ—ã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
                <input type="date" id="date-picker" onchange="onDatePick(event)">
            </div>
            <button class="date-nav-btn" onclick="changeDate(1)">â¯</button>
        </div>

        <div class="label-text">MENTAL LOG</div>
        <div class="dot-container" id="dot-display"></div>
        
        <div style="margin-top:auto; display:grid; gap:16px;">
            <button class="big-btn" onclick="showGameSelect()">PLAY START</button>
            <button class="btn-outline" onclick="showScreen('history-screen')">åˆ†æã¨è¨˜éŒ²</button>
        </div>
    </div>

    <div id="settings-screen" class="screen">
        <h2>ã‚¢ãƒ—ãƒªè¨­å®š</h2>
        <button id="settings-back-btn" class="btn-outline" style="margin-bottom:20px;" onclick="returnFromSettings()">â† æˆ»ã‚‹</button>

        <div style="margin-bottom:30px;">
            <h3 style="font-size:1em; color:var(--text-sub); margin-bottom:12px;">ãƒœã‚¿ãƒ³ã®è¨€è‘‰</h3>
            <div class="setting-input-group" style="border-left: 6px solid var(--color-green);">
                <label class="setting-label">æˆåŠŸãƒœã‚¿ãƒ³ï¼ˆç·‘ï¼‰</label>
                <input type="text" id="setting-calm-text" class="setting-input" placeholder="ä¾‹: è½ã¡ç€ã„ã¦ãŸ">
            </div>
            <div class="setting-input-group" style="border-left: 6px solid var(--color-red);">
                <label class="setting-label">å¤±æ•—ãƒœã‚¿ãƒ³ï¼ˆèµ¤ï¼‰</label>
                <input type="text" id="setting-tilt-text" class="setting-input" placeholder="ä¾‹: ãƒ†ã‚£ãƒ«ãƒˆã—ãŸ">
            </div>
            <button class="btn-outline" onclick="saveButtonSettings()">è¨€è‘‰ã‚’ä¿å­˜</button>
        </div>

        <div style="margin-bottom:30px;">
            <h3 style="font-size:1em; color:var(--text-sub); margin-bottom:12px;">ç”»é¢è¡¨ç¤ºãƒ—ãƒªã‚»ãƒƒãƒˆã®ç·¨é›†</h3>
            <div class="setting-input-group">
                <label class="setting-label">æ–°ã—ã„ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’è¿½åŠ </label>
                <textarea id="new-preset-text" placeholder="è¡¨ç¤ºã•ã›ãŸã„è¨€è‘‰ï¼ˆæ”¹è¡ŒOKï¼‰"></textarea>
                <div class="color-picker-row">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <label style="font-size:0.8em;">èƒŒæ™¯:</label>
                        <input type="color" id="new-preset-bg" value="#000000" oninput="updatePreview()">
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <label style="font-size:0.8em;">æ–‡å­—:</label>
                        <input type="color" id="new-preset-color" value="#ffffff" oninput="updatePreview()">
                    </div>
                </div>
                <div style="margin-top:15px;">
                    <label style="font-size:0.8em;">æ–‡å­—ã‚µã‚¤ã‚º: <span id="size-preview-val">15</span>% (vmin)</label>
                    <input type="range" id="new-preset-size" min="5" max="50" value="15" oninput="updatePreview()">
                </div>
                <div id="preview-box" style="margin-top:15px; padding:20px; text-align:center; font-weight:900; background:#000; color:#fff; border-radius:8px; border:1px solid #ccc;">
                    ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </div>
                <button class="big-btn" style="margin-top:15px; font-size:1em; padding:12px;" onclick="addNewPreset()">è¿½åŠ ã™ã‚‹</button>
            </div>
            <label style="font-size:0.8em; color:var(--text-sub); display:block; margin-bottom:10px;">ç™»éŒ²æ¸ˆã¿ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
            <div id="settings-preset-list" class="list-container"></div>
        </div>

        <div style="margin-bottom:30px;">
            <h3 style="font-size:1em; color:var(--text-sub); margin-bottom:12px;">å¤±æ•—ã®åŸå› ãƒªã‚¹ãƒˆ</h3>
            <div id="settings-reason-list" class="list-container"></div>
            <button class="btn-outline" style="margin-top:10px; border-style:dashed;" onclick="addNewReason()">ï¼‹ åŸå› ã‚’è¿½åŠ </button>
        </div>

        <div style="margin-bottom:30px; border-top:1px solid var(--border-color); padding-top:20px;">
            <h3 style="font-size:1em; color:var(--text-sub); margin-bottom:12px;">ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
            <div style="font-size:0.8em; color:var(--text-sub); margin-bottom:10px;">æ©Ÿç¨®å¤‰æ›´ã®æ™‚ã‚„ã€å®šæœŸçš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«ã€‚</div>
            <button class="btn-outline" onclick="exportDataFile()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜</button>
            <div style="height:10px;"></div>
            <button class="btn-outline" onclick="triggerImport()" style="background:#fff4f4; border-color:#edd;">ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ</button>
            <input type="file" id="import-file-input" style="display:none;" onchange="importDataFile(this)">
        </div>
    </div>

    <div id="game-select-screen" class="screen">
        <h2>ç«¶æŠ€ã‚’é¸æŠ</h2>
        <div style="text-align:center; font-size:0.8em; color:var(--text-sub); margin-bottom:20px;">ãƒ—ãƒ¬ã‚¤ã™ã‚‹ç«¶æŠ€ã‚’é¸ã‚“ã§ãã ã•ã„</div>
        <div id="game-list-container" class="list-container"></div>
        <button class="btn-outline" style="margin-top:20px;" onclick="showScreen('home-screen')">æˆ»ã‚‹</button>
    </div>

    <div id="play-hub-screen" class="screen">
        <div class="hub-container">
            <div style="text-align:center;">
                <div style="font-size:0.9em; color:var(--text-sub); margin-bottom:10px;">NOW PLAYING</div>
                <div id="current-game-title" class="hub-title" style="margin-bottom:15px;">GAME</div>
                <div id="session-stats-box" style="background:#fff; padding:15px; border-radius:12px; box-shadow:var(--shadow); margin-bottom:20px; border:1px solid var(--border-color);">
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:8px;">
                        <span style="font-size:0.8em; color:var(--text-sub); font-weight:bold;">ä»Šæ—¥ã®ãƒ¡ãƒ³ã‚¿ãƒ«å‹ç‡</span>
                        <span id="session-rate-text" style="font-size:1.2em; font-weight:900; color:var(--text-main);">--%</span>
                    </div>
                    <div style="width:100%; height:12px; background:#eee; border-radius:6px; overflow:hidden;">
                        <div id="session-rate-bar" style="width:0%; height:100%; background:var(--color-green); transition:width 0.5s;"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:0.8em; color:var(--text-sub);">
                        <span>ğŸŸ¢ <span id="session-calm-val">0</span></span>
                        <span>ğŸ”´ <span id="session-tilt-val">0</span></span>
                    </div>
                </div>
            </div>
            <button id="play-calm-btn" class="btn-green" style="height:80px;" onclick="recordCalm()">è½ã¡ç€ã„ã¦ãŸ</button>
            <button id="play-tilt-btn" class="btn-red" style="height:80px;" onclick="goToTiltReason()">ãƒ†ã‚£ãƒ«ãƒˆã—ãŸ</button>
            <button class="btn-blue" style="height:80px; margin-top:10px;" onclick="goToDisplayMode()">ç”»é¢ã«æ–‡å­—ã‚’è¡¨ç¤º</button>
        </div>
        <button class="btn-outline" onclick="showScreen('home-screen')">çµ‚äº†ã—ã¦ãƒ›ãƒ¼ãƒ ã¸</button>
    </div>

    <div id="tilt-reason-screen" class="screen">
        <h2>å¤±æ•—ã—ãŸç†ç”±</h2>
        <div style="text-align:center; font-size:0.9em; color:var(--text-sub); margin-bottom:20px;">ä»Šã®æ°—æŒã¡ã«è¿‘ã„ã‚‚ã®ã‚’é¸æŠ</div>
        <div id="reasons-container" style="text-align:center; padding:10px 0;"></div>
        <input type="text" id="custom-reason" placeholder="ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰" style="width:100%; padding:16px; margin-top:20px;">
        <div style="margin-top:auto;">
            <button class="big-btn" onclick="recordTiltData()">ä¿å­˜ã™ã‚‹</button>
            <button class="btn-outline" onclick="cancelTiltReason()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <div id="display-screen" class="screen">
        <div id="display-text-area" onclick="toggleControls()">
            ã‚¬ãƒã§<br>å‹ã¡ã«è¡Œã
        </div>
        <div id="display-controls" class="controls-overlay">
            
            <div class="drag-handle"></div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button id="overlay-calm-btn" class="btn-green" style="flex:1; padding:20px 10px; font-size:1em; margin:0;" onclick="recordCalm()">è½ã¡ç€ã„ã¦ãŸ</button>
                <button id="overlay-tilt-btn" class="btn-red" style="flex:1; padding:20px 10px; font-size:1em; margin:0;" onclick="goToTiltReason(true)">ãƒ†ã‚£ãƒ«ãƒˆ</button>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label style="font-weight:bold; color:#555;">ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
                <span id="wake-lock-status" style="font-size:11px; color:#888; background:#eee; padding:4px 8px; border-radius:4px;">ğŸ’¡ å¸¸æ™‚ç‚¹ç¯OFF</span>
            </div>
            
            <div id="display-preset-list" class="preset-list"></div>
            
            <button class="btn-outline" style="margin-top:10px;" onclick="goToSettingsFromDisplay()">âš™ï¸ ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®šãƒ»ç·¨é›†</button>

            <button onclick="toggleFullScreen()" class="btn-outline" style="margin-top:10px; background:#fff; color:#333; border:1px solid #ccc;">â›¶ å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰</button>
            
            <button onclick="exitDisplayMode()" class="btn-outline" style="margin-top:10px; border:none; background:#eee;">ãƒ—ãƒ¬ã‚¤ç”»é¢ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="history-screen" class="screen">
        <h2>åˆ†æã¨è¨˜éŒ²</h2>
        <div class="filter-card">
            <div class="filter-row">
                <div style="flex:1;">
                    <label style="font-size:0.75em; font-weight:bold; display:block; margin-bottom:6px; color:var(--text-sub);">æœŸé–“</label>
                    <select id="history-period" onchange="onHistoryPeriodChange()">
                        <option value="ALL">å…¨æœŸé–“</option>
                        <option value="DATE">æ—¥ä»˜æŒ‡å®š</option>
                    </select>
                </div>
                <div style="flex:1; display:none;" id="history-date-wrapper">
                    <label style="font-size:0.75em; font-weight:bold; display:block; margin-bottom:6px; color:var(--text-sub);">æ—¥ä»˜</label>
                    <input type="date" id="history-date-picker" onchange="renderHistoryWithFilter()">
                </div>
            </div>
            <div>
                <label style="font-size:0.75em; font-weight:bold; display:block; margin-bottom:6px; color:var(--text-sub);">ç«¶æŠ€</label>
                <select id="history-filter" onchange="renderHistoryWithFilter()">
                    <option value="ALL">ã™ã¹ã¦</option>
                </select>
            </div>
        </div>
        <div id="stats-container">
            <div class="stats-card">
                <div class="stats-header">ãƒ¡ãƒ³ã‚¿ãƒ«å‹ç‡</div>
                <div style="display:flex; align-items:baseline; justify-content:space-between;">
                    <div style="font-size:3em; font-weight:900; color:var(--color-dark);" id="stats-rate">--%</div>
                    <div style="font-size:0.9em; color:var(--text-sub);"><span id="stats-calm-count">0</span> / <span id="stats-total-count">0</span> è©¦åˆ</div>
                </div>
                <div class="win-rate-bar-bg"><div class="win-rate-bar-fill" id="stats-rate-bar"></div></div>
            </div>
            <div class="stats-card">
                <div class="stats-header">å¤±æ•—ã®åŸå›  TOP3</div>
                <div id="stats-reasons-list"><div style="color:var(--text-sub); text-align:center; padding:10px;">ãƒ‡ãƒ¼ã‚¿ãªã—</div></div>
            </div>
        </div>
        <h3 style="font-size:1em; color:var(--text-sub); margin:30px 0 10px 0;">è¨˜éŒ²ä¸€è¦§</h3>
        <div id="history-list"></div>
        <button onclick="showScreen('home-screen')" class="btn-outline" style="margin-top:20px;">æˆ»ã‚‹</button>
        <button onclick="clearData()" style="background:transparent; color:#999; font-size:12px; margin-top:40px; border:none; box-shadow:none; text-decoration:underline;">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="nice-popup">NICE!</div>

    <script>
        const DEFAULT_REASONS = ["ç„¦ã£ãŸ", "ä»–äººã®ç›®ã‚’æ°—ã«ã—ãŸ", "ç›®å…ˆã®åˆ©ç›Šã«å›šã‚ã‚ŒãŸ", "æ„Ÿæƒ…çš„ã«ãªã£ãŸ"];
        const DEFAULT_PRESETS = [
            { text: "ã‚¬ãƒã§\nå‹ã¡ã«è¡Œã", bg: "#111111", color: "#ffffff", size: "15" },
            { text: "è½ã¡ç€ã", bg: "#7A9D54", color: "#ffffff", size: "15" },
            { text: "æ·±å‘¼å¸ã™ã‚‹", bg: "#6A8caf", color: "#ffffff", size: "15" }
        ];

        let activeGame = "";
        let selectedReasons = [];
        let wakeLock = null;
        let calmLabel = "è½ã¡ç€ã„ã¦ãŸ";
        let tiltLabel = "è½ã¡ç€ã‘ãªã‹ã£ãŸ";
        let viewDate = new Date();
        let isFromDisplayMode = false;
        let returnToDisplay = false;

        window.onload = function() {
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                splash.classList.add('fade-out');
                setTimeout(() => splash.style.display = 'none', 500); 
            }, 1500);

            setupSwipeToClose(); // â˜…ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ã®åˆæœŸåŒ–ã‚’è¿½åŠ 

            updateDateDisplay();
            loadDots();
            loadSettings();
            
            if (!localStorage.getItem('tilt_reasons_list')) {
                localStorage.setItem('tilt_reasons_list', JSON.stringify(DEFAULT_REASONS));
            }
            if (!localStorage.getItem('tilt_display_presets')) {
                localStorage.setItem('tilt_display_presets', JSON.stringify(DEFAULT_PRESETS));
            }
            let presets = JSON.parse(localStorage.getItem('tilt_display_presets'));
            if(presets && presets.length > 0) applyPreset(presets[0]);
            updatePreview();
        };

        // --- â˜… æ–°æ©Ÿèƒ½ï¼šä¸‹ã«ã‚¹ãƒ¯ã‚¤ãƒ—ã§é–‰ã˜ã‚‹å‡¦ç† ---
        function setupSwipeToClose() {
            const controls = document.getElementById('display-controls');
            let startY = 0;
            let isDragging = false;

            controls.addEventListener('touchstart', (e) => {
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒä¸€ç•ªä¸Šã®ã¨ãã ã‘ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                if (controls.scrollTop <= 0) {
                    startY = e.touches[0].clientY;
                    isDragging = true;
                } else {
                    isDragging = false;
                }
            }, {passive: true});

            controls.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const currentY = e.touches[0].clientY;
                const deltaY = currentY - startY;

                // ä¸‹æ–¹å‘ã«å¼•ã£å¼µã£ã¦ã„ã‚‹ã¨ãã®ã¿å‡¦ç†
                if (deltaY > 0) {
                    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ‰ãƒ©ãƒƒã‚°ã•ã›ã‚‹
                    if(e.cancelable) e.preventDefault(); 
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚ªãƒ•ã«ã—ã¦æŒ‡ã«è¿½å¾“ã•ã›ã‚‹
                    controls.style.transition = 'none';
                    controls.style.transform = `translateY(${deltaY}px)`;
                }
            }, {passive: false});

            controls.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚ªãƒ³ã«æˆ»ã™
                controls.style.transition = '';
                
                // ç¾åœ¨ã®ç§»å‹•é‡ã‚’å–å¾—ï¼ˆtransformã‹ã‚‰è§£æï¼‰
                const style = window.getComputedStyle(controls);
                const matrix = new WebKitCSSMatrix(style.transform);
                const currentTranslateY = matrix.m42; // Yè»¸ã®ç§»å‹•é‡

                // 120pxä»¥ä¸Šå¼•ã£å¼µã£ãŸã‚‰é–‰ã˜ã‚‹
                if (currentTranslateY > 120) {
                    controls.classList.remove('show'); // é–‰ã˜ã‚‹
                    // æ¬¡å›é–‹ãã¨ãã®ãŸã‚ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
                    setTimeout(() => controls.style.transform = '', 300);
                } else {
                    // å…ƒã«æˆ»ã‚‹ï¼ˆãƒãƒã®ã‚ˆã†ã«ï¼‰
                    controls.style.transform = '';
                }
            });
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            if(screenId === 'home-screen') { loadDots(); returnToDisplay = false; }
            if(screenId === 'history-screen') initHistoryScreen();
            if(screenId === 'settings-screen') renderSettingsAll();
            if(screenId === 'display-screen') renderDisplayPresets();
        }

        function goToSettingsFromDisplay() {
            returnToDisplay = true;
            showScreen('settings-screen');
        }

        function returnFromSettings() {
            if(returnToDisplay) {
                showScreen('display-screen');
                requestWakeLock();
                returnToDisplay = false;
            } else {
                showScreen('home-screen');
            }
        }

        function renderSettingsAll() {
            renderSettingsList(); renderSettingsPresets();
            const backBtn = document.getElementById('settings-back-btn');
            if(returnToDisplay) {
                backBtn.innerText = "â† ãƒ—ãƒ¬ã‚¤ç”»é¢ã«æˆ»ã‚‹";
                backBtn.style.background = "#eef";
            } else {
                backBtn.innerText = "â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹";
                backBtn.style.background = "var(--card-bg)";
            }
        }

        function renderSettingsPresets() {
            const list = document.getElementById('settings-preset-list');
            list.innerHTML = '';
            let presets = JSON.parse(localStorage.getItem('tilt_display_presets') || '[]');
            presets.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="color-dot" style="background:${p.bg};"></div>
                        <span class="item-text" style="white-space:pre-wrap; font-size:0.9em;">${p.text}</span>
                        <span style="font-size:0.8em; color:#888;">ã‚µã‚¤ã‚º:${p.size || 15}</span>
                    </div>
                    <button class="delete-btn" onclick="deletePreset(${index})">âœ•</button>
                `;
                list.appendChild(div);
            });
        }

        function updatePreview() {
            const text = document.getElementById('new-preset-text').value || "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼";
            const bg = document.getElementById('new-preset-bg').value;
            const color = document.getElementById('new-preset-color').value;
            const size = document.getElementById('new-preset-size').value;
            const box = document.getElementById('preview-box');
            box.innerText = text; box.style.backgroundColor = bg; box.style.color = color;
            document.getElementById('size-preview-val').innerText = size;
        }

        function addNewPreset() {
            const text = document.getElementById('new-preset-text').value;
            const bg = document.getElementById('new-preset-bg').value;
            const color = document.getElementById('new-preset-color').value;
            const size = document.getElementById('new-preset-size').value;
            if(!text) { alert("æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            let presets = JSON.parse(localStorage.getItem('tilt_display_presets') || '[]');
            presets.push({ text: text, bg: bg, color: color, size: size });
            localStorage.setItem('tilt_display_presets', JSON.stringify(presets));
            document.getElementById('new-preset-text').value = "";
            renderSettingsPresets();
        }

        function deletePreset(index) {
            if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                let presets = JSON.parse(localStorage.getItem('tilt_display_presets') || '[]');
                presets.splice(index, 1);
                localStorage.setItem('tilt_display_presets', JSON.stringify(presets));
                renderSettingsPresets();
            }
        }

        function renderDisplayPresets() {
            const list = document.getElementById('display-preset-list');
            list.innerHTML = '';
            let presets = JSON.parse(localStorage.getItem('tilt_display_presets') || '[]');
            presets.forEach(p => {
                const div = document.createElement('div');
                div.className = 'preset-item';
                div.onclick = () => applyPreset(p);
                div.innerHTML = `<div class="color-dot" style="background:${p.bg};"></div>${p.text.replace(/\n/g, ' ').substring(0, 10)}`;
                list.appendChild(div);
            });
        }

        function applyPreset(preset) {
            const area = document.getElementById('display-text-area');
            const screen = document.getElementById('display-screen');
            area.innerText = preset.text; area.style.color = preset.color; screen.style.backgroundColor = preset.bg;
            const size = preset.size || 15; area.style.fontSize = size + "vmin";
        }

        function renderSettingsList() {
            const list = document.getElementById('settings-reason-list');
            list.innerHTML = '';
            let reasons = JSON.parse(localStorage.getItem('tilt_reasons_list') || '[]');
            reasons.forEach((reason, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<span class="item-text">${reason}</span><button class="delete-btn" onclick="deleteReason(${index})">âœ•</button>`;
                list.appendChild(div);
            });
        }
        function addNewReason() {
            const name = prompt("æ–°ã—ã„åŸå› ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if(name) {
                let reasons = JSON.parse(localStorage.getItem('tilt_reasons_list') || '[]');
                reasons.push(name);
                localStorage.setItem('tilt_reasons_list', JSON.stringify(reasons));
                renderSettingsList();
            }
        }
        function deleteReason(index) {
            if(confirm('ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                let reasons = JSON.parse(localStorage.getItem('tilt_reasons_list') || '[]');
                reasons.splice(index, 1);
                localStorage.setItem('tilt_reasons_list', JSON.stringify(reasons));
                renderSettingsList();
            }
        }

        function changeDate(offset) { viewDate.setDate(viewDate.getDate() + offset); updateDateDisplay(); loadDots(); }
        function updateDateDisplay() {
            const days = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
            const str = `${viewDate.getMonth()+1}/${viewDate.getDate()} (${days[viewDate.getDay()]})`;
            document.getElementById('current-date-text').innerText = str;
            const y = viewDate.getFullYear(); const m = String(viewDate.getMonth() + 1).padStart(2, '0'); const d = String(viewDate.getDate()).padStart(2, '0');
            document.getElementById('date-picker').value = `${y}-${m}-${d}`;
        }
        function onDatePick(e) { if(e.target.value) { viewDate = new Date(e.target.value); updateDateDisplay(); loadDots(); } }

        function loadSettings() {
            calmLabel = localStorage.getItem('tilt_label_calm') || "è½ã¡ç€ã„ã¦ãŸ";
            tiltLabel = localStorage.getItem('tilt_label_tilt') || "è½ã¡ç€ã‘ãªã‹ã£ãŸ";
            document.getElementById('setting-calm-text').value = calmLabel;
            document.getElementById('setting-tilt-text').value = tiltLabel;
            updatePlayButtons();
        }
        function saveButtonSettings() {
            const newCalm = document.getElementById('setting-calm-text').value;
            const newTilt = document.getElementById('setting-tilt-text').value;
            if(newCalm) { calmLabel = newCalm; localStorage.setItem('tilt_label_calm', calmLabel); }
            if(newTilt) { tiltLabel = newTilt; localStorage.setItem('tilt_label_tilt', tiltLabel); }
            alert('è¨€è‘‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            updatePlayButtons();
        }
        function updatePlayButtons() {
            document.getElementById('play-calm-btn').innerText = calmLabel;
            document.getElementById('play-tilt-btn').innerText = tiltLabel;
            document.getElementById('overlay-calm-btn').innerText = calmLabel;
            document.getElementById('overlay-tilt-btn').innerText = tiltLabel;
        }

        function showGameSelect() {
            const list = document.getElementById('game-list-container');
            list.innerHTML = '';
            let games = JSON.parse(localStorage.getItem('tilt_user_games') || '[]');
            games.forEach((game, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<span class="item-text" onclick="startGame('${game}')">${game}</span><button class="delete-btn" onclick="deleteGame(${index})">âœ•</button>`;
                list.appendChild(div);
            });
            const addBtn = document.createElement('div');
            addBtn.className = 'list-item add-btn-dashed';
            addBtn.innerText = 'ï¼‹ ç«¶æŠ€ã‚’è¿½åŠ ';
            addBtn.onclick = addNewGame;
            list.appendChild(addBtn);
            showScreen('game-select-screen');
        }
        function addNewGame() {
            const name = prompt("ç«¶æŠ€åã‚’å…¥åŠ›");
            if(name) {
                let games = JSON.parse(localStorage.getItem('tilt_user_games') || '[]');
                games.push(name);
                localStorage.setItem('tilt_user_games', JSON.stringify(games));
                showGameSelect();
            }
        }
        function deleteGame(index) {
            if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                let games = JSON.parse(localStorage.getItem('tilt_user_games') || '[]');
                games.splice(index, 1);
                localStorage.setItem('tilt_user_games', JSON.stringify(games));
                showGameSelect();
            }
        }
        function startGame(gameName) {
            activeGame = gameName;
            document.getElementById('current-game-title').innerText = gameName;
            updateSessionStats();
            showScreen('play-hub-screen');
        }

        function goToDisplayMode() { 
            showScreen('display-screen'); 
            requestWakeLock(); 
            isFromDisplayMode = false;
        }
        function exitDisplayMode() { 
            releaseWakeLock(); 
            showScreen('play-hub-screen'); 
        }

        function recordCalm() {
            if(confirm(`ã€Œ${calmLabel}ã€ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
                saveData('calm', [], calmLabel);
                const popup = document.getElementById('nice-popup');
                popup.classList.add('pop');
                setTimeout(() => popup.classList.remove('pop'), 1500);
            }
        }

        function goToTiltReason(fromDisplay = false) {
            isFromDisplayMode = fromDisplay;
            selectedReasons = [];
            const container = document.getElementById('reasons-container');
            container.innerHTML = '';
            let currentReasons = JSON.parse(localStorage.getItem('tilt_reasons_list') || '[]');
            currentReasons.forEach(r => {
                const btn = document.createElement('span');
                btn.className = 'reason-btn';
                btn.innerText = r;
                btn.onclick = () => {
                    if(selectedReasons.includes(r)) {
                        selectedReasons = selectedReasons.filter(i => i !== r);
                        btn.classList.remove('selected');
                    } else {
                        selectedReasons.push(r);
                        btn.classList.add('selected');
                    }
                };
                container.appendChild(btn);
            });
            document.getElementById('custom-reason').value = '';
            showScreen('tilt-reason-screen');
        }
        
        function recordTiltData() {
            const custom = document.getElementById('custom-reason').value;
            let finalReasons = [...selectedReasons];
            if(custom) finalReasons.push(custom);
            saveData('tilt', finalReasons, tiltLabel);
            returnToPreviousScreen();
        }
        function cancelTiltReason() { returnToPreviousScreen(); }

        function returnToPreviousScreen() {
            if(isFromDisplayMode) {
                showScreen('display-screen');
                requestWakeLock();
                document.getElementById('display-controls').classList.remove('show');
            } else {
                showScreen('play-hub-screen');
            }
        }

        function saveData(mental, reasons, labelText) {
            const record = { date: new Date().toISOString(), game: activeGame, mental: mental, label: labelText, reasons: reasons };
            let records = JSON.parse(localStorage.getItem('tilt_records') || '[]');
            records.push(record);
            localStorage.setItem('tilt_records', JSON.stringify(records));
            updateSessionStats();
        }

        function updateSessionStats() {
            const now = new Date();
            const todayStr = now.toDateString(); 
            let records = JSON.parse(localStorage.getItem('tilt_records') || '[]');
            const sessionRecords = records.filter(r => (new Date(r.date).toDateString() === todayStr) && (r.game === activeGame));
            const total = sessionRecords.length;
            const calmCount = sessionRecords.filter(r => r.mental === 'calm').length;
            const tiltCount = total - calmCount;
            const rate = total === 0 ? 0 : Math.round((calmCount / total) * 100);

            document.getElementById('session-rate-text').innerText = rate + "%";
            document.getElementById('session-calm-val').innerText = calmCount;
            document.getElementById('session-tilt-val').innerText = tiltCount;
            const bar = document.getElementById('session-rate-bar');
            bar.style.width = rate + "%";
            
            if(rate < 50 && total > 0) {
                bar.style.backgroundColor = "var(--color-red)";
                document.getElementById('session-rate-text').style.color = "var(--color-red)";
            } else {
                bar.style.backgroundColor = "var(--color-green)";
                document.getElementById('session-rate-text').style.color = "var(--color-dark)";
            }
        }

        async function requestWakeLock() { try { if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); document.getElementById('wake-lock-status').innerText = "ğŸ’¡ å¸¸æ™‚ç‚¹ç¯ON"; wakeLock.addEventListener('release', () => { document.getElementById('wake-lock-status').innerText = "ğŸ’¡ å¸¸æ™‚ç‚¹ç¯OFF"; }); } } catch (err) {} }
        async function releaseWakeLock() { if (wakeLock !== null) { await wakeLock.release(); wakeLock = null; } }

        function loadDots() {
            const container = document.getElementById('dot-display');
            let records = JSON.parse(localStorage.getItem('tilt_records') || '[]');
            const targetDateStr = viewDate.toDateString();
            const targetRecords = records.filter(r => new Date(r.date).toDateString() === targetDateStr);
            container.innerHTML = targetRecords.length ? '' : '<div style="color:#aaa; font-size:0.8em;">NO DATA</div>';
            targetRecords.forEach(r => {
                const dot = document.createElement('div');
                dot.className = `dot ${r.mental === 'calm' ? 'green' : 'red'}`;
                container.appendChild(dot);
            });
        }

        function toggleControls() { document.getElementById('display-controls').classList.toggle('show'); }
        function clearData() { if(confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.clear(); location.reload(); } }

        function initHistoryScreen() {
            const now = new Date();
            const y = now.getFullYear(); const m = String(now.getMonth() + 1).padStart(2, '0'); const d = String(now.getDate()).padStart(2, '0');
            document.getElementById('history-date-picker').value = `${y}-${m}-${d}`;
            document.getElementById('history-period').value = "ALL";
            onHistoryPeriodChange();
            
            const filterSelect = document.getElementById('history-filter');
            filterSelect.innerHTML = '<option value="ALL">ã™ã¹ã¦</option>';
            let userGames = JSON.parse(localStorage.getItem('tilt_user_games') || '[]');
            let records = JSON.parse(localStorage.getItem('tilt_records') || '[]');
            let recordGames = [...new Set(records.map(r => r.game))];
            let allGameOptions = [...new Set([...userGames, ...recordGames])];
            allGameOptions.forEach(game => { if(!game) return; const o = document.createElement('option'); o.value = game; o.innerText = game; filterSelect.appendChild(o); });
            renderHistoryWithFilter();
        }

        function onHistoryPeriodChange() {
            const period = document.getElementById('history-period').value;
            document.getElementById('history-date-wrapper').style.display = (period === 'DATE') ? 'block' : 'none';
            renderHistoryWithFilter();
        }

        function renderHistoryWithFilter() {
            const periodVal = document.getElementById('history-period').value;
            const dateVal = document.getElementById('history-date-picker').value;
            const gameVal = document.getElementById('history-filter').value;
            let records = JSON.parse(localStorage.getItem('tilt_records') || '[]');

            if(periodVal === 'DATE' && dateVal) {
                records = records.filter(r => {
                    const rDate = new Date(r.date);
                    const rY = rDate.getFullYear(); const rM = String(rDate.getMonth() + 1).padStart(2, '0'); const rD = String(rDate.getDate()).padStart(2, '0');
                    return `${rY}-${rM}-${rD}` === dateVal;
                });
            }
            if(gameVal !== "ALL") records = records.filter(r => r.game === gameVal);

            const total = records.length;
            const calmCount = records.filter(r => r.mental === 'calm').length;
            const calmRate = total === 0 ? 0 : Math.round((calmCount / total) * 100);

            let reasonCounts = {};
            records.forEach(r => { if(r.mental === 'tilt' && r.reasons) r.reasons.forEach(re => reasonCounts[re] = (reasonCounts[re] || 0) + 1); });
            let sortedReasons = Object.entries(reasonCounts).sort((a, b) => b[1] - a[1]);

            document.getElementById('stats-rate').innerText = `${calmRate}%`;
            document.getElementById('stats-calm-count').innerText = calmCount;
            document.getElementById('stats-total-count').innerText = total;
            document.getElementById('stats-rate-bar').style.width = `${calmRate}%`;
            document.getElementById('stats-rate-bar').style.backgroundColor = calmRate < 50 ? 'var(--color-red)' : 'var(--color-green)';

            const reasonListDiv = document.getElementById('stats-reasons-list');
            reasonListDiv.innerHTML = '';
            if(sortedReasons.length === 0) reasonListDiv.innerHTML = '<div style="color:var(--text-sub); text-align:center; padding:5px;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            else sortedReasons.slice(0, 5).forEach((item, index) => {
                const div = document.createElement('div'); div.className = 'reason-rank-item';
                div.innerHTML = `<span>${index+1}. ${item[0]}</span><span style="font-weight:bold;">${item[1]}å›</span>`;
                reasonListDiv.appendChild(div);
            });

            const list = document.getElementById('history-list');
            list.innerHTML = '';
            if(records.length === 0) { list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sub);">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
            records.reverse().forEach(r => {
                const date = new Date(r.date);
                const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                let displayLabel = r.label || (r.mental === 'calm' ? "è½ã¡ç€ã„ã¦ãŸ" : "ãƒ†ã‚£ãƒ«ãƒˆã—ãŸ");
                const div = document.createElement('div'); div.className = 'list-item'; div.style.marginBottom = "10px"; div.style.cursor = "default";
                div.innerHTML = `
                    <div style="width:100%;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                            <strong style="color:var(--text-main);">${r.game}</strong>
                            <span style="font-size:0.8em; color:var(--text-sub);">${timeStr}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="color:${r.mental === 'calm' ? 'var(--color-green)' : 'var(--color-red)'}; font-weight:bold;">â— ${displayLabel}</span>
                        </div>
                        ${r.reasons && r.reasons.length > 0 ? `<div style="font-size:0.85em; color:var(--text-sub); margin-top:6px; background:#f5f5f5; padding:6px; border-radius:4px;">ç†ç”±: ${r.reasons.join(', ')}</div>` : ''}
                    </div>`;
                list.appendChild(div);
            });
        }

        function exportDataFile() {
            const data = {
                records: JSON.parse(localStorage.getItem('tilt_records') || '[]'),
                reasons: JSON.parse(localStorage.getItem('tilt_reasons_list') || '[]'),
                presets: JSON.parse(localStorage.getItem('tilt_display_presets') || '[]'),
                games: JSON.parse(localStorage.getItem('tilt_user_games') || '[]'),
                calmLabel: localStorage.getItem('tilt_label_calm'),
                tiltLabel: localStorage.getItem('tilt_label_tilt')
            };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mental_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            alert('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nå¤§åˆ‡ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚');
        }

        function triggerImport() {
            document.getElementById('import-file-input').click();
        }

        function importDataFile(input) {
            const file = input.files[0];
            if (!file) return;

            if(!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä»Šã®ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã™ï¼‰')) {
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.records) localStorage.setItem('tilt_records', JSON.stringify(data.records));
                    if(data.reasons) localStorage.setItem('tilt_reasons_list', JSON.stringify(data.reasons));
                    if(data.presets) localStorage.setItem('tilt_display_presets', JSON.stringify(data.presets));
                    if(data.games) localStorage.setItem('tilt_user_games', JSON.stringify(data.games));
                    if(data.calmLabel) localStorage.setItem('tilt_label_calm', data.calmLabel);
                    if(data.tiltLabel) localStorage.setItem('tilt_label_tilt', data.tiltLabel);
                    alert('å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸï¼\nã‚¢ãƒ—ãƒªã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚');
                    location.reload();
                } catch(err) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\næ­£ã—ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        // --- â˜… æ–°æ©Ÿèƒ½ï¼šå…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼ˆJSï¼‰ ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else {
                    // iPhone/iPadç”¨ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹
                    alert("iPhoneã®å ´åˆã€Safariã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå…±æœ‰ãƒœã‚¿ãƒ³ï¼‰ã‹ã‚‰\nã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€\nã‚’ã™ã‚‹ã¨ã€å®Œå…¨ãªå…¨ç”»é¢ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ãˆã¾ã™ï¼");
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
    </script>
</body>
</html>
